name: Weekly Content Deployment

on:
  schedule:
    # Deploy one new page every Tuesday and Friday at 9am ET (2pm UTC)
    - cron: '0 14 * * 2,5'
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy-content:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Find next page to deploy
        id: find_page
        run: |
          # Get list of pages already in root
          DEPLOYED=$(ls -1 *.html 2>/dev/null | sort)

          # Get list of pages in content library
          LIBRARY=$(ls -1 content-library/*.html 2>/dev/null | xargs -n1 basename | sort)

          # Find first page in library that's not deployed
          for page in $LIBRARY; do
            if ! echo "$DEPLOYED" | grep -q "^$page$"; then
              echo "next_page=$page" >> $GITHUB_OUTPUT
              echo "Found page to deploy: $page"
              exit 0
            fi
          done

          echo "next_page=" >> $GITHUB_OUTPUT
          echo "All pages already deployed!"

      - name: Deploy page from library
        if: steps.find_page.outputs.next_page != ''
        run: |
          PAGE="${{ steps.find_page.outputs.next_page }}"
          echo "Deploying: $PAGE"

          # Copy from library to root
          cp "content-library/$PAGE" "./$PAGE"

          # Update sitemap
          TODAY=$(date +%Y-%m-%d)
          SLUG=$(basename "$PAGE" .html)

          # Add entry before </urlset>
          sed -i "s|</urlset>|  <url>\n    <loc>https://bestdelraysalon.com/$PAGE</loc>\n    <lastmod>$TODAY</lastmod>\n    <changefreq>monthly</changefreq>\n    <priority>0.8</priority>\n  </url>\n</urlset>|" sitemap.xml

          echo "Page deployed and sitemap updated"

      - name: Update deployment log
        if: steps.find_page.outputs.next_page != ''
        run: |
          mkdir -p .deployment-log
          echo "$(date -u +%Y-%m-%dT%H:%M:%SZ) - Deployed: ${{ steps.find_page.outputs.next_page }}" >> .deployment-log/history.txt

      - name: Commit and push
        if: steps.find_page.outputs.next_page != ''
        run: |
          git config user.name "Content Bot"
          git config user.email "bot@bestdelraysalon.com"
          git add -A
          git commit -m "Deploy content: ${{ steps.find_page.outputs.next_page }}

          Automated weekly content deployment from library.

          ðŸ¤– Generated with GitHub Actions"
          git push

      - name: Summary
        run: |
          DEPLOYED_COUNT=$(ls -1 *.html 2>/dev/null | wc -l)
          LIBRARY_COUNT=$(ls -1 content-library/*.html 2>/dev/null | wc -l)
          REMAINING=$((LIBRARY_COUNT - DEPLOYED_COUNT + 5)) # +5 for original pages

          echo "## Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed this run:** ${{ steps.find_page.outputs.next_page || 'None (all deployed)' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Total live pages:** $DEPLOYED_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **Remaining in library:** ~$REMAINING" >> $GITHUB_STEP_SUMMARY
